// Serial.c

#include "Serial.h"
#include <stdarg.h>
#include "mainpp.h" // 包含 mainpp.h 来获取声明
// ? main.h ?,????? extern "C" ??? huart3
extern UART_HandleTypeDef huart1;

uint8_t Serial_RxData;	// ???????????
uint8_t Serial_RxFlag;	// ????????????

/**
  * @brief  ????? (?? HAL ?,?????? CubeMX ??)
  * @param  None
  * @retval None
  * @note   ?????????????
  */
void Serial_Init(void)
{
    // CubeMX ??? main() ?????? MX_USART3_UART_Init()
    // ?? GPIO?USART ???NVIC ????????
    
    // ?????????????? UART ?????
    // HAL_UART_Receive_IT ???????,??????1???????
    // ??????,?????,??? HAL_UART_RxCpltCallback ?????
    HAL_UART_Receive_IT(&huart1, &Serial_RxData, 1);
}

/**
  * @brief  ???????? (???)
  * @param  Byte ????????
  * @retval None
  */
void Serial_SendByte(uint8_t Byte)
{
    // HAL_UART_Transmit ???????????
    // ??????????????
    // ??: UART??, ????, ????, ????(ms)
    HAL_UART_Transmit(&huart1, &Byte, 1, 1000);
}

/**
  * @brief  ????????
  * @param  Array ?????????
  * @param  Length ????????
  * @retval None
  */
void Serial_SendArray(uint8_t *Array, uint16_t Length)
{
    // HAL ???????????,???
    HAL_UART_Transmit(&huart1, Array, Length, 1000);
}

/**
  * @brief  ?????????
  * @param  String ??????????
  * @retval None
  */
void Serial_SendString(char *String)
{
    uint16_t i = 0;
    while (String[i] != '\0')
    {
        i++;
    }
    HAL_UART_Transmit(&huart1, (uint8_t *)String, i, 1000);
}

/**
  * @brief  ???? (????)
  * @retval ?????X?Y??
  */
static uint32_t Serial_Pow(uint32_t X, uint32_t Y)
{
    uint32_t Result = 1;
    while (Y--)
    {
        Result *= X;
    }
    return Result;
}

/**
  * @brief  ??????
  * @param  Number ??????
  * @param  Length ????????
  * @retval None
  */
void Serial_SendNumber(uint32_t Number, uint8_t Length)
{
    uint8_t i;
    for (i = 0; i < Length; i++)
    {
        Serial_SendByte(Number / Serial_Pow(10, Length - i - 1) % 10 + '0');
    }
}

/**
  * @brief  ??? printf ???? fputc (?? Keil/MDK)
  * @param  ch ??????
  * @param  f ????
  * @retval ???????
  */
int fputc(int ch, FILE *f)
{
    HAL_UART_Transmit(&huart1, (uint8_t *)&ch, 1, 1000);
    return ch;
}

// ????? GCC (? STM32CubeIDE),??? printf ???? _write ??
// int _write(int file, char *ptr, int len)
// {
//     HAL_UART_Transmit(&huart3, (uint8_t *)ptr, len, 1000);
//     return len;
// }

/**
  * @brief  ????? printf ??
  * @param  format ??????
  * @param  ... ???????
  * @retval None
  */
void Serial_Printf(char *format, ...)
{
    char String[100];
    va_list arg;
    va_start(arg, format);
    vsprintf(String, format, arg);
    va_end(arg);
    Serial_SendString(String);
}

/**
  * @brief  ?????????
  * @retval ???????,???????
  */
uint8_t Serial_GetRxFlag(void)
{
    if (Serial_RxFlag == 1)
    {
        Serial_RxFlag = 0;
        return 1;
    }
    return 0;
}

/**
  * @brief  ?????????
  * @retval ?????
  */
uint8_t Serial_GetRxData(void)
{
    return Serial_RxData;
}

/**
  * @brief  HAL ? UART ????????
  * @param  huart: ????? UART ??
  * @retval None
  * @note   ??????? HAL ????????,?????????
  *         ? HAL_UART_Receive_IT ?????,?????????
  */
void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)
{
    // ?????????? USART3 ?????
    if (huart->Instance == USART1) {
        Serial_RxFlag = 1;
        HAL_UART_Receive_IT(&huart1, &Serial_RxData, 1);
    }
//    else if (huart->Instance == USART3) {
//        rosserial_rx_cb(); // 调用 C 风格接口
//    }
}

void HAL_UART_TxCpltCallback(UART_HandleTypeDef *huart)
{
    // 判断是哪个串口触发了发送中断
//    if (huart->Instance == USART3) {
//        rosserial_tx_cb(); // 调用 C 风格接口
//    }
}

